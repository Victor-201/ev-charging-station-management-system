<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charging Station - API Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(238, 9, 121, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .response-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .response-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .token-display {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            word-break: break-all;
        }

        .token-display strong {
            color: #856404;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .api-endpoint {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .api-endpoint .method {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        .method-get {
            background: #28a745;
            color: white;
        }

        .method-post {
            background: #007bff;
            color: white;
        }

        .method-put {
            background: #ffc107;
            color: #333;
        }

        .method-delete {
            background: #dc3545;
            color: white;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .vehicle-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .vehicle-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .vehicle-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .vehicle-info div {
            font-size: 0.9rem;
        }

        .vehicle-info strong {
            color: #666;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .user-table tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-staff {
            background: #ffc107;
            color: #333;
        }

        .role-driver {
            background: #28a745;
            color: white;
        }

        .status-active {
            color: #28a745;
            font-weight: 600;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: 600;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            font-weight: 600;
            color: #333;
        }

        .search-filter {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .search-filter {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° EV Charging Station Management</h1>
            <p>API Test Dashboard - Microservices Architecture</p>
            <div id="user-role-display" style="margin-top: 10px; font-size: 1rem;"></div>
        </div>

        <!-- Authentication Section -->
        <div class="card" id="auth-section">
            <h2>üîê Authentication</h2>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="login-email" value="driver@example.com" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="login-password" value="password123" placeholder="Enter your password">
            </div>

            <button class="btn btn-primary" onclick="login()">üîë Login</button>
            <button class="btn btn-secondary" onclick="logout()">üö™ Logout</button>

            <div id="token-display" class="token-display hidden">
                <strong>üé´ Access Token:</strong>
                <div id="token-value" style="margin-top: 10px; font-size: 0.85rem;"></div>
            </div>

            <div id="auth-response" class="response-box hidden">
                <pre id="auth-response-text"></pre>
            </div>
        </div>

        <!-- User Profile Section -->
        <div class="card" id="profile-section" class="hidden">
            <h2>üë§ User Profile</h2>
            
            <button class="btn btn-success" onclick="getMyProfile()">üìã Get My Profile</button>
            <button class="btn btn-success" onclick="getUserDetails()">üöó Get Profile + Vehicles</button>

            <div id="profile-response" class="response-box hidden">
                <pre id="profile-response-text"></pre>
            </div>

            <div id="vehicles-display" class="hidden" style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üöó My Vehicles</h3>
                <div id="vehicles-list"></div>
            </div>
        </div>

        <!-- Vehicle Management Section -->
        <div class="card" id="vehicle-section">
            <h2>üöó Vehicle Management</h2>

            <div class="grid-2">
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Add New Vehicle</h3>
                    
                    <div class="form-group">
                        <label>Plate Number:</label>
                        <input type="text" id="vehicle-plate" placeholder="e.g., 30A-12345">
                    </div>

                    <div class="form-group">
                        <label>Brand:</label>
                        <input type="text" id="vehicle-brand" placeholder="e.g., Tesla">
                    </div>

                    <div class="form-group">
                        <label>Model:</label>
                        <input type="text" id="vehicle-model" placeholder="e.g., Model 3">
                    </div>

                    <div class="form-group">
                        <label>Battery (kWh):</label>
                        <input type="number" id="vehicle-battery" placeholder="e.g., 75">
                    </div>

                    <div class="form-group">
                        <label>Color:</label>
                        <input type="text" id="vehicle-color" placeholder="e.g., White">
                    </div>

                    <div class="form-group">
                        <label>Year:</label>
                        <input type="number" id="vehicle-year" placeholder="e.g., 2024">
                    </div>

                    <button class="btn btn-primary" onclick="addVehicle()">‚ûï Add Vehicle</button>
                </div>

                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Vehicle Actions</h3>
                    
                    <div class="form-group">
                        <label>Vehicle ID:</label>
                        <input type="text" id="vehicle-id" placeholder="Enter vehicle ID">
                    </div>

                    <button class="btn btn-success" onclick="getVehicles()">üìã Get My Vehicles</button>
                    <button class="btn btn-danger" onclick="deleteVehicle()">üóëÔ∏è Delete Vehicle</button>
                </div>
            </div>

            <div id="vehicle-response" class="response-box hidden">
                <pre id="vehicle-response-text"></pre>
            </div>
        </div>

        <!-- Admin Dashboard Section (Only visible for admin users) -->
        <div class="card" id="admin-section" class="hidden">
            <h2>üëë Admin Dashboard - User Management</h2>
            
            <div class="search-filter">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Search (Email/Name):</label>
                    <input type="text" id="admin-search" placeholder="Search by email or name...">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Role Filter:</label>
                    <select id="admin-role-filter">
                        <option value="">All Roles</option>
                        <option value="driver">Driver</option>
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Status Filter:</label>
                    <select id="admin-status-filter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label>Page Size:</label>
                    <select id="admin-page-size">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="getAllUsers()">üîç Search Users</button>
            <button class="btn btn-secondary" onclick="clearAdminFilters()">üîÑ Clear Filters</button>

            <div id="admin-users-display" class="hidden">
                <div style="margin-top: 20px; color: #666; font-weight: 600;">
                    <span id="admin-total-users">Total: 0 users</span>
                </div>
                
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Phone</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-tbody">
                    </tbody>
                </table>

                <div class="pagination">
                    <button id="prev-page" onclick="changePage(-1)">‚¨ÖÔ∏è Previous</button>
                    <span id="page-info">Page 1</span>
                    <button id="next-page" onclick="changePage(1)">Next ‚û°Ô∏è</button>
                </div>
            </div>

            <div id="admin-response" class="response-box hidden">
                <pre id="admin-response-text"></pre>
            </div>
        </div>

        <!-- API Endpoints Reference -->
        <div class="card">
            <h2>üìö API Endpoints Reference</h2>
            
            <div class="grid-2">
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Auth Service (Port 3001)</h3>
                    <div class="api-endpoint">
                        <span class="method method-post">POST</span>
                        <code>/api/v1/auth/register</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-post">POST</span>
                        <code>/api/v1/auth/login</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-post">POST</span>
                        <code>/api/v1/auth/refresh</code>
                    </div>
                </div>

                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">User Service (Port 3002)</h3>
                    <div class="api-endpoint">
                        <span class="method method-get">GET</span>
                        <code>/api/v1/auth/me</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-get">GET</span>
                        <code>/api/v1/users/:id</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-post">POST</span>
                        <code>/api/v1/users/:id/vehicles</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-get">GET</span>
                        <code>/api/v1/users/:id/vehicles</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-delete">DELETE</span>
                        <code>/api/v1/vehicles/:id</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-get">GET</span>
                        <code>/api/v1/users (Admin Only)</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-post">POST</span>
                        <code>/api/v1/users/:id/deactivate (Admin)</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-get">GET</span>
                        <code>/api/v1/users/:id/export-data (GDPR)</code>
                    </div>
                    <div class="api-endpoint">
                        <span class="method method-delete">DELETE</span>
                        <code>/api/v1/users/:id/erase (GDPR)</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const AUTH_API = 'http://localhost:3001/api/v1';
        const USER_API = 'http://localhost:3002/api/v1';
        
        let accessToken = localStorage.getItem('accessToken');
        let currentUserId = localStorage.getItem('userId');
        let currentUserRole = localStorage.getItem('userRole');
        let currentPage = 1;
        let totalPages = 1;

        // Update UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (accessToken) {
                showTokenDisplay();
                updateUIForRole();
            }
        });

        function updateUIForRole() {
            const roleDisplay = document.getElementById('user-role-display');
            const adminSection = document.getElementById('admin-section');
            
            if (currentUserRole) {
                roleDisplay.innerHTML = `<span class="status-badge status-info">Logged in as: <strong>${currentUserRole.toUpperCase()}</strong></span>`;
                
                // Show admin section if user is admin
                if (currentUserRole === 'admin') {
                    adminSection.classList.remove('hidden');
                }
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            try {
                const response = await fetch(`${AUTH_API}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.accessToken;
                    currentUserId = data.user_id;
                    currentUserRole = data.role;
                    
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('userId', currentUserId);
                    localStorage.setItem('userRole', data.role);

                    showResponse('auth-response', data, 'success');
                    showTokenDisplay();
                    updateUIForRole();
                    
                    alert('‚úÖ Login successful!');
                } else {
                    showResponse('auth-response', data, 'error');
                    alert('‚ùå Login failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                showResponse('auth-response', { error: error.message }, 'error');
                alert('‚ùå Network error: ' + error.message);
            }
        }

        function logout() {
            accessToken = null;
            currentUserId = null;
            currentUserRole = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('userRole');
            
            document.getElementById('token-display').classList.add('hidden');
            document.getElementById('token-value').textContent = '';
            document.getElementById('user-role-display').innerHTML = '';
            document.getElementById('admin-section').classList.add('hidden');
            
            alert('üëã Logged out successfully');
        }

        function showTokenDisplay() {
            const tokenDisplay = document.getElementById('token-display');
            const tokenValue = document.getElementById('token-value');
            
            tokenDisplay.classList.remove('hidden');
            tokenValue.textContent = accessToken;
        }

        async function getMyProfile() {
            if (!accessToken) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            try {
                const response = await fetch(`${USER_API}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResponse('profile-response', data, 'success');
                } else {
                    showResponse('profile-response', data, 'error');
                }
            } catch (error) {
                showResponse('profile-response', { error: error.message }, 'error');
            }
        }

        async function getUserDetails() {
            if (!accessToken || !currentUserId) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            try {
                const response = await fetch(`${USER_API}/users/${currentUserId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResponse('profile-response', data, 'success');
                    
                    // Display vehicles in a nice format
                    if (data.vehicles && data.vehicles.length > 0) {
                        displayVehicles(data.vehicles);
                    }
                } else {
                    showResponse('profile-response', data, 'error');
                }
            } catch (error) {
                showResponse('profile-response', { error: error.message }, 'error');
            }
        }

        async function addVehicle() {
            if (!accessToken || !currentUserId) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            const vehicleData = {
                plate_number: document.getElementById('vehicle-plate').value,
                brand: document.getElementById('vehicle-brand').value,
                model: document.getElementById('vehicle-model').value,
                battery_kwh: parseFloat(document.getElementById('vehicle-battery').value),
                color: document.getElementById('vehicle-color').value,
                year: parseInt(document.getElementById('vehicle-year').value)
            };

            if (!vehicleData.plate_number || !vehicleData.brand || !vehicleData.model) {
                alert('‚ö†Ô∏è Please fill in required fields');
                return;
            }

            try {
                const response = await fetch(`${USER_API}/users/${currentUserId}/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(vehicleData)
                });

                const data = await response.json();

                if (response.ok) {
                    showResponse('vehicle-response', data, 'success');
                    alert('‚úÖ Vehicle added successfully!');
                    
                    // Clear form
                    document.getElementById('vehicle-plate').value = '';
                    document.getElementById('vehicle-brand').value = '';
                    document.getElementById('vehicle-model').value = '';
                    document.getElementById('vehicle-battery').value = '';
                    document.getElementById('vehicle-color').value = '';
                    document.getElementById('vehicle-year').value = '';
                } else {
                    showResponse('vehicle-response', data, 'error');
                    alert('‚ùå Failed to add vehicle');
                }
            } catch (error) {
                showResponse('vehicle-response', { error: error.message }, 'error');
            }
        }

        async function getVehicles() {
            if (!accessToken || !currentUserId) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            try {
                const response = await fetch(`${USER_API}/users/${currentUserId}/vehicles`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResponse('vehicle-response', data, 'success');
                    
                    if (data.vehicles && data.vehicles.length > 0) {
                        displayVehicles(data.vehicles);
                    }
                } else {
                    showResponse('vehicle-response', data, 'error');
                }
            } catch (error) {
                showResponse('vehicle-response', { error: error.message }, 'error');
            }
        }

        async function deleteVehicle() {
            const vehicleId = document.getElementById('vehicle-id').value;
            
            if (!accessToken) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            if (!vehicleId) {
                alert('‚ö†Ô∏è Please enter vehicle ID');
                return;
            }

            if (!confirm('Are you sure you want to delete this vehicle?')) {
                return;
            }

            try {
                const response = await fetch(`${USER_API}/vehicles/${vehicleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResponse('vehicle-response', data, 'success');
                    alert('‚úÖ Vehicle deleted successfully!');
                    document.getElementById('vehicle-id').value = '';
                } else {
                    showResponse('vehicle-response', data, 'error');
                    alert('‚ùå Failed to delete vehicle');
                }
            } catch (error) {
                showResponse('vehicle-response', { error: error.message }, 'error');
            }
        }

        function displayVehicles(vehicles) {
            const vehiclesDisplay = document.getElementById('vehicles-display');
            const vehiclesList = document.getElementById('vehicles-list');
            
            vehiclesDisplay.classList.remove('hidden');
            vehiclesList.innerHTML = '';

            vehicles.forEach(vehicle => {
                const vehicleCard = document.createElement('div');
                vehicleCard.className = 'vehicle-card';
                vehicleCard.innerHTML = `
                    <h4>üöó ${vehicle.brand} ${vehicle.model}</h4>
                    <div class="vehicle-info">
                        <div><strong>Plate:</strong> ${vehicle.plate_number}</div>
                        <div><strong>Battery:</strong> ${vehicle.battery_kwh} kWh</div>
                        <div><strong>Color:</strong> ${vehicle.color || 'N/A'}</div>
                        <div><strong>Year:</strong> ${vehicle.year || 'N/A'}</div>
                        <div style="grid-column: 1 / -1;"><strong>ID:</strong> <code>${vehicle.vehicle_id}</code></div>
                    </div>
                `;
                vehiclesList.appendChild(vehicleCard);
            });
        }

        function showResponse(elementId, data, status) {
            const responseBox = document.getElementById(elementId);
            const responseText = document.getElementById(elementId + '-text');
            
            responseBox.classList.remove('hidden');
            
            let statusBadge = '';
            if (status === 'success') {
                statusBadge = '<span class="status-badge status-success">‚úÖ Success</span><br>';
            } else if (status === 'error') {
                statusBadge = '<span class="status-badge status-error">‚ùå Error</span><br>';
            }

            responseText.innerHTML = statusBadge + JSON.stringify(data, null, 2);
        }

        // ==================== ADMIN FUNCTIONS ====================

        async function getAllUsers() {
            if (!accessToken) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            if (currentUserRole !== 'admin') {
                alert('‚ö†Ô∏è Only admin users can access this feature');
                return;
            }

            const search = document.getElementById('admin-search').value;
            const role = document.getElementById('admin-role-filter').value;
            const status = document.getElementById('admin-status-filter').value;
            const pageSize = document.getElementById('admin-page-size').value;

            // Build query parameters
            const params = new URLSearchParams();
            params.append('page', currentPage);
            params.append('size', pageSize);
            if (search) params.append('q', search);
            if (role) params.append('role', role);
            if (status) params.append('status', status);

            try {
                const response = await fetch(`${USER_API}/users?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayUsersList(data);
                    showResponse('admin-response', data, 'success');
                } else {
                    showResponse('admin-response', data, 'error');
                    alert('‚ùå Failed to fetch users: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                showResponse('admin-response', { error: error.message }, 'error');
                alert('‚ùå Network error: ' + error.message);
            }
        }

        function displayUsersList(data) {
            const usersDisplay = document.getElementById('admin-users-display');
            const tbody = document.getElementById('admin-users-tbody');
            const totalDisplay = document.getElementById('admin-total-users');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            usersDisplay.classList.remove('hidden');
            
            // Update total count
            totalDisplay.textContent = `Total: ${data.total || 0} users`;
            
            // Calculate total pages
            const pageSize = parseInt(document.getElementById('admin-page-size').value);
            totalPages = Math.ceil((data.total || 0) / pageSize);
            
            // Update pagination
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;

            // Clear and populate table
            tbody.innerHTML = '';

            if (!data.users || data.users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No users found</td></tr>';
                return;
            }

            data.users.forEach(user => {
                const row = document.createElement('tr');
                
                const roleClass = `role-${user.role || 'driver'}`;
                const statusClass = user.status === 'active' ? 'status-active' : 'status-inactive';
                const createdAt = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A';
                
                // Determine if user can be deactivated
                const isActive = user.status === 'active';
                const deactivateBtn = isActive 
                    ? `<button class="btn btn-danger btn-sm" onclick="deactivateUser('${user.user_id}', '${user.email}')">üîí Deactivate</button>`
                    : `<span style="color: #999; font-size: 0.85rem;">Already inactive</span>`;
                
                // GDPR action buttons
                const gdprButtons = `
                    <button class="btn btn-success btn-sm" onclick="exportUserData('${user.user_id}', '${user.email}')" style="margin-top: 5px;">üì¶ Export Data</button>
                    <button class="btn btn-warning btn-sm" onclick="eraseUserData('${user.user_id}', '${user.email}')" style="margin-top: 5px;">üóëÔ∏è Erase Data</button>
                `;
                
                row.innerHTML = `
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.name || 'N/A'}</td>
                    <td><span class="role-badge ${roleClass}">${(user.role || 'driver').toUpperCase()}</span></td>
                    <td><span class="${statusClass}">${(user.status || 'active').toUpperCase()}</span></td>
                    <td>${user.phone || 'N/A'}</td>
                    <td>${createdAt}</td>
                    <td>
                        ${deactivateBtn}
                        ${gdprButtons}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function changePage(delta) {
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            getAllUsers();
        }

        function clearAdminFilters() {
            document.getElementById('admin-search').value = '';
            document.getElementById('admin-role-filter').value = '';
            document.getElementById('admin-status-filter').value = '';
            document.getElementById('admin-page-size').value = '10';
            currentPage = 1;
            
            // Clear display
            document.getElementById('admin-users-display').classList.add('hidden');
            document.getElementById('admin-response').classList.add('hidden');
        }

        async function deactivateUser(userId, userEmail) {
            if (!accessToken) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            if (currentUserRole !== 'admin') {
                alert('‚ö†Ô∏è Only admin users can deactivate accounts');
                return;
            }

            // Confirm action
            const confirmed = confirm(`‚ö†Ô∏è Are you sure you want to deactivate user: ${userEmail}?\n\nThis will lock their account and they won't be able to login.`);
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`${USER_API}/users/${userId}/deactivate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ User ${userEmail} has been deactivated successfully!`);
                    showResponse('admin-response', data, 'success');
                    // Refresh user list
                    getAllUsers();
                } else {
                    alert(`‚ùå Failed to deactivate user: ${data.error || data.message || 'Unknown error'}`);
                    showResponse('admin-response', data, 'error');
                }
            } catch (error) {
                alert('‚ùå Network error: ' + error.message);
                showResponse('admin-response', { error: error.message }, 'error');
            }
        }

        // ==================== GDPR FUNCTIONS ====================

        async function exportUserData(userId, userEmail) {
            if (!accessToken) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            if (currentUserRole !== 'admin') {
                alert('‚ö†Ô∏è Only admin users can export user data');
                return;
            }

            // Confirm action
            const confirmed = confirm(`üì¶ Export all data for user: ${userEmail}?\n\nThis will create a ZIP file with all personal data according to GDPR Article 15 (Right to Access).`);
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`${USER_API}/users/${userId}/export-data`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message with download link
                    const message = `‚úÖ Data export successful!\n\n` +
                        `Export URL: ${data.export_url}\n` +
                        `File Size: ${(data.file_size_bytes / 1024).toFixed(2)} KB\n` +
                        `Exported At: ${new Date(data.exported_at).toLocaleString()}\n\n` +
                        `Click OK to open download link in new tab.`;
                    
                    alert(message);
                    
                    // Open download link in new tab
                    window.open(data.export_url, '_blank');
                    
                    showResponse('admin-response', data, 'success');
                } else {
                    alert(`‚ùå Failed to export user data: ${data.error || data.message || 'Unknown error'}`);
                    showResponse('admin-response', data, 'error');
                }
            } catch (error) {
                alert('‚ùå Network error: ' + error.message);
                showResponse('admin-response', { error: error.message }, 'error');
            }
        }

        async function eraseUserData(userId, userEmail) {
            if (!accessToken) {
                alert('‚ö†Ô∏è Please login first');
                return;
            }

            if (currentUserRole !== 'admin') {
                alert('‚ö†Ô∏è Only admin users can erase user data');
                return;
            }

            // Strong confirmation with detailed warning
            const warning = `‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL WARNING ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n` +
                `You are about to PERMANENTLY DELETE/ANONYMIZE all data for:\n` +
                `User: ${userEmail}\n\n` +
                `This action will:\n` +
                `‚úó Anonymize user profile (name, phone, address)\n` +
                `‚úó Delete all vehicles (plate numbers)\n` +
                `‚úó Cancel all subscriptions\n` +
                `‚úó Delete all notifications\n` +
                `‚úó Anonymize wallet transactions\n\n` +
                `This complies with GDPR Article 17 (Right to be Forgotten).\n` +
                `This action CANNOT be undone!\n\n` +
                `Type "DELETE" to confirm:`;

            const userInput = prompt(warning);
            
            if (userInput !== 'DELETE') {
                alert('‚ùå Erase operation cancelled. User typed: ' + (userInput || '(nothing)'));
                return;
            }

            // Second confirmation
            const finalConfirm = confirm(`üî¥ FINAL CONFIRMATION\n\nAre you absolutely sure you want to erase all data for ${userEmail}?\n\nClick OK to proceed with data erasure.`);
            if (!finalConfirm) {
                alert('‚ùå Erase operation cancelled.');
                return;
            }

            try {
                const response = await fetch(`${USER_API}/users/${userId}/erase`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const message = `‚úÖ Data erasure request queued successfully!\n\n` +
                        `User: ${userEmail}\n` +
                        `Status: ${data.status}\n\n` +
                        `${data.message || 'Data will be processed within 30 days per GDPR regulations.'}\n\n` +
                        `An audit log has been created in the database.`;
                    
                    alert(message);
                    showResponse('admin-response', data, 'success');
                    
                    // Refresh user list after 2 seconds
                    setTimeout(() => {
                        getAllUsers();
                    }, 2000);
                } else {
                    alert(`‚ùå Failed to erase user data: ${data.error || data.message || 'Unknown error'}`);
                    showResponse('admin-response', data, 'error');
                }
            } catch (error) {
                alert('‚ùå Network error: ' + error.message);
                showResponse('admin-response', { error: error.message }, 'error');
            }
        }
    </script>
</body>
</html>
